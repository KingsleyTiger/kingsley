# Session Initiation Protocol Vulnerability

### 201727270721_박기범

## index

- Session 3way handshaking
  - 3way handshaking
  - 3way handshaking vulnerability
- ABOUT SIP
  - What is SIP?
  - How SIP Work?
  - Vulnerability scan tools
  - About Vulnerability
- Resolving Security Issues
- Conclusion
- Reference

---

## Session 3way handshaking[1]

서버에 데이터를 요청하는 클라이언트가 서버와 연결하는 방법으로 3way handshaking이 있다. 이 방법은 연결지향적인 TCP를 기반으로 사용된다. 연결을 유지하기 위해서 호스트들은 sequence number를 사용하여 다음에 들어올 패킷의 순서를 예측한다.  클라이언트가 새로운 패킷을  받으면 ACK 패킷을 전달해 데이터를 정상적으로 받았고, 다음 패킷을 기다리고 있다고 알려준다. 이러한 방법을 그림으로 자세히 살펴보자.

![3way](https://github.com/KingsleyTiger/kingsley/tree/Network_Vul/SIP_Essay/PIC/3way.png)


1.client가 랜덤한 sequence number를 가진 syn 패킷을 서버에 전송한다.
2.서버는 클라이언트에게 랜덤한 sequence number를 가진 syn-ack 패킷을 돌려주고
클라이언트의 다음 sequence number를 알수 있다.
3.클라이언트는 ack number를 서버에게 보내고, 서버의 다음 sequence nubmer를 알수 있다.
4.서버와 클라이언트 모두 sequence number가 동기화 되면, 그제서야 모두 데이터를 전송할 수 있다.

클라이언트가 서버에게 sequence number 100을 전송하면 서버는 syn+ack의 sequence number와 ACK를 다음에 받을 sequnece number를 지정해 전송한다.
syn+ack를 받은 클라이언트는 전송 받은 ACK 값을 sequence number로 하는 ACK를 전송한다. 이 때 ack의 ack는 다음에 syn전송 후 받을 syn+ack의 sequence number이다.

## 3way handshaking vulnerability[2]

3 way handshaking 과정을 이용해 많은 공격이 발생할 수 있다.
간단한 예를 몇개 들어보자면 

- syn flooding 공격
  클라이언트가 수많은 syn 패킷을 전송해 서버가 감당할 수 없을 정도에 다다르면 서버는 더이상 서비스를 제공할 수 없는 DoS 상태가 된다.

- port scan
  클라이언트가 서버의 특정 포트가 열려있는지, 닫혀있는지 확인 하기 위해서 syn,FIN,PSH 등의 패킷들을 전송한 후 어떤 응답이 오는지에 따라 포트의 오픈 여부를 확인하는 공격이다.

- Session hijacking
  정상적인 클라이언트와 서버가 연결을 유지하고 있는 과정에서 공격자가 서버와 연결을 하기 위해 정상 클라이언트의 sequence number를 예측하여 서버에게 연결 요청을 보낸다. 이 과정에서 정상 클라이언트가 서버와의 연결을 끊어지게 만들기 위해서 공격자는 RST 패킷을 전송해 정상적인 연결을 끊는다.

## About SIP[3]

Session Initiation Protocol(SIP)은 IETF에서 정의한 시그널링 프로토콜이다. 여기서 시그널링 프로토콜이란 통신의 상대방을 찾아 호/세션 등의 성립, 유지, 해제를 관리하는 프로토콜을 의미한다.  이 시그널링 프로토콜을 이용해 VoIP와 인터넷 기반의 화상통화 등멀티미디어 서비스의 세션을 생성하고 유지,해제한다. TCP와 UDP를 사용하여 requests/reply 요청을 전송하기 때문에 HTTP와 비슷한 구조를 가진다. Session Description Protocol(SDP)를 사용해 어떤 프로토콜을 사용할 지  제어할 수 있다. 
또한 텍스트를 기반으로 한 requests/reply를 전송하기 때문에 문제를 관리하고 제어하기에 편리함이 있다. requests/reply에서 사용되는 메세지는 세션에 참가한 참가자들에 대한 정보와 어떻게 네트워크에 도달할 지 설명해준다.
--여기에 그림-- 
기본적으로 3way handshaking과 비슷하게 invite ,200 OK, ACK 3개의 패킷만 전송된다. 이런 기본적인 흐름을 "호 절차"라고 한다. 
실제로 사용되는 호 절차를 알아보자.
--여기에 그림2--
왼쪽 전화를 유저1, 가운데 SIP 서버를 서버, 오른쪽 전화를 유저2라 명칭하자.

1.유저1이 서버에게 유저2를 초대하겠다는 초대 텍스트를 전송하면 서버는 유저2에게 이 텍스트를 전송한다.
2.서버가 유저2에게 초대 텍스트를 전송하기 전에 100 Trying이라는 패킷을 전송해 아직  초대 텍스트가 전송되지 않았다고 알려준다. 여기까지의 과정은 초대 텍스트가 전송되는 순간에 발생된다.
3.유저2로 부터 180Ringing을 응답받으면 유저2의 전화에 벨이 울리고 있으니 유저1에게 링백톤(수신 대기음)을 재생하라고 알려준다.
4.이 후 연결이 성립된 후, 한명이 수화기를 내려 놓으면 BYE 요청이 전송되고 200 OK응답을 받아 세션을 종료한다. 

이런 실질적인 절차를 back-to-back user agent라고 한다.

##  How VoIP call is originated?

네트워크를 사용해 연결하는 VoIP는 어떤 과정으로 생성되는지 알아보자.

 1.시그널링 프로토콜로 세션,채널 성립

 2.아날로그의 음성 데이터를 디지털로 변환

 3.코덱으로 인코딩

 4.인코딩된 데이터를 패킷화

 5.패킷을 네트워크를 통해 전송



## SIP vulnerability[5] [6] [7] [8]

이제 이 프로토콜의 어디서 취약점이 발생하는지 알아보자.

### 1.Flooding Attack

flooding attack을 하기 위해서 syn flooding 공격과 비슷하게 공격자는 INVITE,REGISTER,OPTION 메소드를 사용한다. REGISTER 메소드는 현재 IP주소와 전화 받을 URL을 알려주는 메소드이고, OPTION 메소드는 통화를 시작하지 않고 호출자의 기능을 가져오는 메소드이다. 그래도 가장 많이 쓰이는건 INVITE 메소드이다. syn 처럼 무수히 많은 초대 텍스트를 보내, 서버의 자원을 고갈시키는 방법이다.

####  1-1.Single source flooding

--여기에 그림--

위 그림은 single caller가 무수히 많은 INVITE 요청을 동시에 보내 flooding 상태를 만든다. 이러한 공격은 송신측의 header필드가 항상 같은 값을 가진다는 특징이 있다. 이러한 점을 이용해 일정량이 이상의 같은 헤더값을 가지는 패킷이 들어오면 차단하는 대응책이 있다. 

####  1-2.Multple source flooding

--여기에 그림--

다수의 caller가 무수히 많은 INVITE를 보내 1-1의 단점을 보완하는 공격 방법이 있다. 

#### 1-3.SIP reflection flooding

--여기에 그림--

인증을 받지 못한 SIP 메세지들이 spoofing을 사용해 가짜 SIP를 생성한다. 공격자가 여러 대의 프록시 서버들에게 INVITE 텍스트를 전송한다. 이 때 헤더의 내용에 수정이 필요하다. 공격자는 출발지 IP를 자신의 주소가 아닌 희생자의 IP로 변경한다. 이 텍스트를 받은 프록시 서버들은 응답을 주기 위해 패킷을 생성하고, 여러 대의 서버들을 일제히 희생자에게 응답 패킷을 전송한다. 의도하지 않은 패킷을 받은 희생자 서버는 자원의 한계를 넘어 결국 DoS 상태가 된다.



### 2.Eavasdropping(도청) 공격

이름 그대로 이 공격은 정보를 빼낼 목적으로 개인적인 대화나 소통을 엿들어 정보를 빼내는 공격이다. 북한이 이 공격을 통해 도청을 한 사건이 있다.
https://en.yna.co.kr/view/AEN20200929004652315

####  2-1.How Eavasdropping is done?

도청 공격은 VoIP가 인터넷을 통해 정보를 전달되어야 한다는 전제조건이 있다. 전화에 참가한 사람의 시그널은 보이스 패킷으로 압축되어 다른 패킷들과 함께 전송된다. 인터넷을 통해 전화를 하고있는 모든 사람들은 음성 패키지에 대한 권한을 얻었다고 할 수 있다. 

VoIP환경에서 공격자는 2가지 공격 방법을 사용한다. 첫 번째 방법은 같은 브로드캐스트 도메인 내의 세션 패킷을 잡아내는 방법이다. 두번째 방법은 접근 시스템에 제한을 걸고 집중된 미디어를 불법 침입자에게 전송하는 방법이다.

--여기에 그림--

공격자 장비는 User A와 비슷하게 같은 도메인 내의 허브를 통하는 모든 시그널을 잡을 수 있다. 

위 그림은 같은 도메인이 아닌 외부의 공격자가 스위치나 라우터에 접속해 오디오,비디오에 추적 포트를 설정해 똑같이 정보를 도청할 수 있다는걸 보여준다.

####  2-2.How Interception is done?

--여기에 RTP 사진--

VoIP를 인터셉트하기 위해 공격자는 RTP스트림을 먼저 인터셉트해야 한다. RTP 스트림은 무엇일까? RTP란 Real Time Protocol로 사용자가 생성한 연속적인 음성 페이로드를 네트워크를 통해 상대방에게 전달한다. 사용자들이 있는 네트워크 내에서 공격자는 전화를 건사람과 전화를 받는 사람 사이에서 ARP spoofing을 사용한다. 공격자가 RTP 스트림을 파악한 후, 음성을 인코딩 하기위한 코덱을 찾아야한다. VoIP 통화는 중간에 연결된 프록시 서버를 통해 "man-in-the-middle" 공격에 의해 노출될 수 있다. 일반적으로 네트워크 서버는 대화를 잡아내 수신자에게 전달하는 역할을 한다. SIP에서는 INVITE 텍스트를 사용해서 전달하기 때문에 텍스트가 암호화되지 않을 수 도 있다. 이런 암호화되지 않은 텍스트들을 공격자는 MITM 서버를 통해 sniffing 할 수 있게 된다.



#### 3.Malformed Message Attack

--여기에 사진 오버플로우 관련--

SIP Malformed Message Attack은 SIP 메세지의 형식을 갖추지 않고 전송되는 메세지들이나 서버가 처리할 수 없는 형식의 메세지를 만들어서 전송하는 방식을 의미한다. 이러한 Malformed message attack의 대상은 DoS와 마찬가지로 타겟 서버가 처리과정에 있어서 부분적으로나 전체적으로 제동을 유발하는 공격 방식이다. 읽을수 없는 메세지를 받은 서버는 다시 클라이언트에게 재전송 요청을 보내거나 메세지를 처리할 때까지 기다린다. 이러한 과정에서 서버는 자원을 소비하면서 처리과정에서 제동이 걸릴수 밖에 없다.



## Resolving Security Issues

 ### About Interception of Calls

VoIP 통화는 같은 네트워크 내에 있을 경우 쉽게 접근해 디코딩 할 수 있다. 하지만 대부분의 네트워크 망이 이더넷 스위치를 사용하여 연결되기 때문에 스위치 레벨에서 접근을 제한할 수 있다. 그러한 방법으로

- 물리적으로 같은 네트워크에 접근하지 못하도록 막기
- VoIP 서비스의 암호화
- 무선랜에서 접근하지 못하도록 암호화
- 스위치에서 허용되지 않은 호스트의 접근 거부

등의 방법이 있다.

### About Denial of Service Attacks

DoS는 공격자가 인증되지 않았거나 원하지 않는 트래픽을 VoIP서비스나 반대편 서버 등에게 전송하는 방식으로 정상적인 서비스 제공을 방해하는 공격이다.  이러한 공격을 막는 방법으로

- 라우터에서 패킷 필터링을 사용한다. DoS 공격을 막기 위한 최선의 방법으로 일정량 이상의 패킷이 들어오면 라우터가 필터링을 하는 방법이다.
- 방화벽에서 차단을 한다. 라우터에서의 필터링이 성공적이지 못했을 때의 대안으로 방화벽을 이용한다.
- Null Routes. 이 방법은 공격자의 IP를 인지하고 있는 상태에서 공격자의 IP가 들어올 경우, 미리 준비해둔 아무것도 없는 라우터로 통신이 들어가게 해 공격을 방어하는 방법이다.



## Conclusion

이와 같이 Session initiation Protocol에 대한 설명과 취약점, 그리고 방어법에 대해 알아보았다. 일단 SIP의 방식이 HTTP와 굉장히 유사한 부분이 많고, TCP/UDP를 사용한다는 점에서 이번 에세이의 주제로 적합하다고 생각했다. TCP 위에서의 취약점에 대해 찾아 보니 유사한 점이 확실히 많았다. 하지만 HTTP와는 다르게 텍스트 형태로 전송되어 평문 노출에 있어서 더욱 취약할 수 있다고 생각되었다. 

---

## Reference

[1] Hsu, Fu-Hau; Hwang, Yan-Ling; Tsai, Cheng-Yu; Cai, Wei-Tai; Lee, Chia-Hao; Chang, KaiWei. 2016. "TRAP: A Three-Way Handshake Server for TCP Connection Establishment" _Appl. Sci._ 6, no. 11: 358. [https://doi.org/10.3390/app6110358]

[2]S. M. Bellovin. 1989. Security problems in the TCP/IP protocol suite. _SIGCOMM Comput. Commun. Rev._ 19, 2 (April 1, 1989), 32–48. DOI:https://doi.org/10.1145/378444.378449

[3] https://en.wikipedia.org/wiki/Session_Initiation_Protocol

[4] https://www.3cx.com/pbx/sip/

[5] Hussain, I., Djahel, S., Zhang, Z., and Naït‐Abdesselam, F. (2015) A comprehensive study of flooding attack consequences and countermeasures in Session Initiation Protocol (SIP). *Security Comm. Networks*, 8: 4436– 4451. doi: [10.1002/sec.1328](https://doi.org/10.1002/sec.1328).

[6] A. Dakur and S. Dakur, "Eavesdropping and interception security hole and its solution over VoIP service," 2014 IEEE Global Conference on Wireless Computing & Networking (GCWCN), 2014, pp. 6-10, doi: 10.1109/GCWCN.2014.7030837.

[7] https://www.velonasystems.com/wp-content/uploads/2018/02/Denial-of-Service-Attacks-against-VoIP-Systems-Velona-WP.pdf

[8] W. Werapun, A. A. El Kalam, B. Paillassa and J. Fasson, "Solution analysis for SIP security threats," 2009 International Conference on Multimedia Computing and Systems, 2009, pp. 174-180, doi: 10.1109/MMCS.2009.5256707.
